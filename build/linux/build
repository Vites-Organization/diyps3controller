#!/bin/bash

#don't forget to add universe to ~/.pbuilderrc

#uncomment in a new build environment
#sudo apt-get install gdebi subversion devscripts pbuilder debhelper

VERSION=`cat version`
PACKAGE=`cat package`

echo "Previous version number:" $VERSION
echo "New version number?"

read NEW_VERSION

if [ -n $NEW_VERSION ]
then
  MAJOR=$(echo $NEW_VERSION | awk -F"." '{print $1}')
  MINOR=$(echo $NEW_VERSION | awk -F"." '{print $2}')
  echo Major release number: $MAJOR
  echo Minor release number: $MINOR
  if [ -z $MAJOR ] || [ -z $MINOR ]
  then
    echo Invalid release number!
    exit
  fi
  
  sed -i "s/#define[ ]*INFO_VERSION[ ]*\"[0-9]*.[0-9]*\"/#define INFO_VERSION \"$MAJOR.$MINOR\"/" GIMX/info.h
  sed -i "s/#define[ ]*INFO_YEAR[ ]*\"2010-[0-9]*\"/#define INFO_YEAR \"2010-$(DATE '+%Y')\"/" GIMX/info.h
fi

if [ -z $NEW_VERSION ]
then
  NEW_VERSION=$VERSION
fi

if [ -n $VERSION ]
then
  sed -i "s/$VERSION/$NEW_VERSION/" debian/changelog
  echo $NEW_VERSION > version
fi

wget http://code.google.com/p/diyps3controller/issues/list?can=7 -O fixed.html
FIXED=`cat fixed.html | grep "id: " | sed 's/[a-z: },]//g' | sed ':a;N;$!ba;s/\n/ /g'`

sed -i "s/  \* Fixed issues: [0-9 ]*/  \* Fixed issues: $FIXED/" debian/changelog

sed -i "s/ -- Matlo <mat.lau@laposte.net>  [^\n]*/ -- Matlo <mat.lau@laposte.net>  $(date -R)/" debian/changelog

sed -i "s/    Matlo <mat.lau@laposte.net> on [^\n]*/    Matlo <mat.lau@laposte.net> on $(date -R)/" debian/copyright

gedit debian/changelog

if ! test -d SDL-1.2.14
then
  if ! test -f SDL-1.2.14.tar.gz
  then
    wget http://www.libsdl.org/release/SDL-1.2.14.tar.gz
    tar xzvf SDL-1.2.14.tar.gz
  fi
  svn export http://diyps3controller.googlecode.com/svn/trunk/libsdl/patch
  cd SDL-1.2.14
  patch -p1 < ../patch
  ./configure ; make
  cd ..
fi

mkdir -p $PACKAGE-$NEW_VERSION

cp -r debian $PACKAGE-$NEW_VERSION
cp Makefile $PACKAGE-$NEW_VERSION

cd $PACKAGE-$NEW_VERSION

svn checkout http://diyps3controller.googlecode.com/svn/trunk/GIMX
mkdir -p libsdl/lib
mkdir -p libsdl/include/SDL
cp ../SDL-1.2.14/build/.libs/libSDL.so libsdl/lib
cp ../SDL-1.2.14/include/* libsdl/include/SDL

debuild --no-tgz-check -S

#uncomment in a new build environment
#sudo pbuilder create

sudo pbuilder build ../$PACKAGE\_$NEW_VERSION-1.dsc

cp /var/cache/pbuilder/result/$PACKAGE\_$NEW_VERSION-1_*.deb ..
